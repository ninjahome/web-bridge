const __globalTweetMemCache=new Map,__globalTweetMemCacheByHash=new Map;let throttleTimer;function throttle(e,t){throttleTimer||(throttleTimer=setTimeout((()=>{e(),clearTimeout(throttleTimer),throttleTimer=null}),t))}function contentScroll(){let e,t;switch(curScrollContentID){case 0:e=cachedGlobalTweets,t=loadOlderTweetsForHomePage;break;case 1:e=cachedUserTweets,t=loadOlderMostVotedTweet;break;case 12:e=cachedTopVotedKolUser,t=loadOlderMostVotedKol;break;case 13:e=cachedTopVoterUser,t=loadOlderMostVoter;break;case 2:e=cachedUserTweets,t=olderPostedTweets;break;case 22:e=cachedUserVotedTweets,t=olderVotedTweets;break;case 51:e=cachedNinjaUserPostedTweets,t=olderNinjaUsrPostedTweets;break;case 52:e=cachedNinjaUserVotedTweets,t=olderNinjaUsrVotedTweets;break;default:return}if(!e.canLoadMoreOldData())return;const o=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight);window.innerHeight+window.scrollY<o-100||(e.isLoading=!0,t().then((()=>{})).finally((()=>{e.isLoading=!1})))}function clearCachedData(){databaseDeleteTable(__constCachedItem),localStorage.clear(),sessionStorage.clear(),window.location.href="/signIn"}async function showHoverCard(e,t,o,n){const a=document.getElementById("hover-card"),r=e.currentTarget.getBoundingClientRect(),s=await loadNJUserInfoFromSrv(o);t?(document.getElementById("hover-avatar").src=t.profile_image_url,document.getElementById("hover-name").textContent=t.name,document.getElementById("hover-user-name").textContent="@"+t.username):document.getElementById("hover-name").textContent=o;let c=0,i=0;if(n&&(c=n.X,i=n.Y),a.style.display="block",a.style.left=`${r.left+c}px`,a.style.top=`${r.bottom+window.scrollY+i}px`,!s)return void console.log("failed to load web3 user:",o);const l=document.getElementById("show-details-button");l.onclick=()=>{a.style.display="none",showUserProfile(s)},l.textContent=i18next.t("show-details-button"),document.getElementById("hover-tweet-count").textContent=s.tweet_count,document.getElementById("hover-vote-count").textContent=s.vote_count,document.getElementById("hover-voted-count").textContent=s.be_voted_count}function hideHoverCard(e){const t=document.getElementById("hover-card");setTimeout((()=>{t.matches(":hover")||e.matches(":hover")||(t.style.display="none")}),300)}function cachedToMem(e,t){e&&e.map((e=>{__globalTweetMemCache.set(e.create_time,e),__globalTweetMemCacheByHash.set(e.prefixed_hash,e),(e.create_time<t.latestID||0===t.latestID)&&(t.latestID=e.create_time),t.CachedItem.push(e)}))}async function TweetsQuery(e,t,o){try{e.start_id=t?0:o.latestID,t&&(o.latestID=0);const n=await PostToSrvByJson("/tweetQuery",e);return o.moreOldTweets=t||n&&0!==n.length,cachedToMem(n,o),o.CachedItem.length>0}catch(e){throw console.log(e),new Error(e)}}async function __setOnlyHeader(e,t,o){const n=await TwitterBasicInfo.loadTwBasicInfo(t),a=await loadNJUserInfoFromSrv(o);if(n)return e.querySelector(".twitterAvatar").src=n.profile_image_url,a&&a.is_elder&&(e.querySelector(".elderFlagOnAvatar").style.display="block"),e.querySelector(".twitterName").textContent=n.name,e.querySelector(".twitterUserName").textContent="@"+n.username,n;const r=await loadTwitterUserInfoFromSrv(t,!0);return r?(e.querySelector(".twitterAvatar").src=r.profile_image_url,a&&a.is_elder&&(e.querySelector(".elderFlagOnAvatar").style.display="block"),e.querySelector(".twitterName").textContent=r.name,e.querySelector(".twitterUserName").textContent="@"+r.username,r):(console.log("failed load twitter user info"),null)}async function showImgRaw(e){e.stopPropagation();try{showWaiting("loading.....");const e=this.getAttribute("data-hash"),t=await loadTweetImgRaw(e);if(!t)return void showDialog(DLevel.Warning,"failed to load raw image");const o=document.querySelector(".tweet-image-raw");o.style.display="block",o.querySelector(".tweet-image-detail").src=t.raw_data,o.querySelector(".tweet-image-hash").innerText=t.hash}catch(e){showDialog(DLevel.Error,e.toString())}finally{hideLoading()}}function CloseImgDetail(){document.querySelector(".tweet-image-raw").style.display="none"}async function loadTweetImgRaw(e){let t=await ImageRawData.load(e);if(t&&t.raw_data)return t;const o=await GetToSrvByJson("/tweetImgRaw?img_hash="+e);return t?t.raw_data=o.raw:t=new ImageRawData(o.hash,o.raw),ImageRawData.sycToDb(t),t}async function loadTweetImgThumb(e){let t=await ImageRawData.load(e);if(t&&t.thumb_nail)return t;const o=await GetToSrvByJson("/tweetImgThumb?img_hash="+e);return t?t.thumb_nail=o.raw:t=new ImageRawData(o.hash,null,o.raw),ImageRawData.sycToDb(t),t}async function procTweetTxt(e){return e.replace(/\t/g,"&nbsp;&nbsp;&nbsp;&nbsp;").replace(/\n/g,"<br>").replace(/ /g,"&nbsp;").replace(/<dessage-img>(.*?)<\/dessage-img>/g,((e,t)=>{const o=t.replace(/\s+/g,"").split(delimiter),n=document.getElementById("image-in-tweet-template").cloneNode(!0);n.id="",n.removeAttribute("id"),n.style.display="grid";for(let e=0;e<o.length;e++){const t=o[e],a=n.querySelector(".image-item-in-tweet").cloneNode(!0);a.style.display="block",a.removeAttribute("id");a.querySelector(".image-src-to-show").setAttribute("data-hash",t),loadTweetImgThumb(t).then((e=>{if(!e)return void console.log("failed to load thumb img=>",t);const o=`[data-hash="${t}"]`;document.querySelectorAll(o).forEach((t=>{t.src=e.thumb_nail,t.onclick=showImgRaw}))})),n.appendChild(a)}return n.outerHTML}))}async function setupCommonTweetHeader(e,t,o){e.querySelector(".tweetCreateTime").textContent=formatTime(t.create_time);const n=await __setOnlyHeader(e,t.twitter_id,t.web3_id),a=e.querySelector(".tweet-content"),r=await procTweetTxt(t.text);a.innerHTML=DOMPurify.sanitize(r);const s=e.querySelector(".tweet-header");return o&&(s.addEventListener("mouseenter",(e=>showHoverCard(e,n,t.web3_id))),s.addEventListener("mouseleave",(()=>hideHoverCard(s)))),a}function showSettingBtn(e){const t=document.getElementById("user-tooltip");t.style.visibility=e?"visible":"hidden"}async function refreshTwitterInfo(){showWaiting("syncing twitter meta"),await loadTwitterUserInfoFromSrv(ninjaUserObj.tw_id,!1,!0),await setupUserBasicInfoInSetting(),hideLoading()}function quitFromService(){fetch("/signOut",{method:"GET"}).then((()=>{window.location.href="/signIn"})).catch((e=>{console.log(e),window.location.href="/signIn"}))}function showTweetDetailInfo(){const e=document.getElementById("tweet-detail-info");"none"===e.style.display?(e.style.display="flex",document.getElementById("tweet-text-info-img").classList.remove("tweet-text-info-img")):(document.getElementById("tweet-text-info-img").classList.add("tweet-text-info-img"),e.style.display="none")}async function showTweetDetail(e,t){const o=document.querySelector("#tweet-detail");o.style.display="block",document.getElementById("tweet-post-on-top").style.display="none";const n=document.getElementById(e);if(!n)return;n.style.display="none",o.querySelector(".tweetCreateTime").textContent=formatTime(t.create_time),await __setOnlyHeader(o,t.twitter_id,t.web3_id);const a=await procTweetTxt(t.text);o.querySelector(".tweet-text").innerHTML=DOMPurify.sanitize(a),o.querySelector(".back-button").onclick=()=>{n.style.display="block",o.style.display="none",document.getElementById("tweet-post-on-top").style.display="block",o.querySelector(".team-members").innerHTML="",o.querySelector(".team-members").style.display="none"},o.querySelector(".tweet-web3_id").textContent=t.web3_id,o.querySelector(".tweet-prefixed-hash").textContent=t.prefixed_hash,o.querySelector(".tweet-signature").textContent=t.signature,o.querySelector(".tweet-vote-number").textContent=t.vote_count,await __showVoteButton(o,t,(function(e){o.querySelector(".tweet-vote-number").textContent=e.vote_count}))}async function __showVoteButton(e,t,o){const n=e.querySelector(".tweet-action-vote");voteContractMeta||await initVoteContractMeta(),n.onclick=()=>voteToTheTweet(t,o)}async function __updateVoteNumberForTweet(e,t){let o=document.getElementById("tweet-card-for-vote-"+e.create_time);if(o&&(o.querySelector(".total-vote-number").textContent=e.vote_count,t)){o.querySelector(".user-vote-number").textContent=t.user_vote_count,cachedVoteStatusForUser.set(t.create_time,t.user_vote_count)}o=document.getElementById("tweet-card-for-user-"+e.create_time),o&&(o.querySelector(".vote-number").textContent=e.vote_count),o=document.getElementById("tweet-card-for-home-"+e.create_time),o&&(o.querySelector(".vote-number").textContent=e.vote_count),o=document.getElementById("tweet-card-for-njusr-vote-"+e.create_time),o&&(o.querySelector(".total-vote-count").textContent=e.vote_count),o=document.getElementById("tweet-card-for-njusr-post-"+e.create_time),o&&(o.querySelector(".total-vote-count").textContent=e.vote_count)}async function voteToTheTweet(e,t){Number(e.payment_status)===TXStatus.Success?openVoteModal((function(o,n){procTweetVotePayment(o,e,(async function(o,a,r){const s=await updateVoteStatusToSrv(o,a,r);if(e.vote_count=s.vote_count,__updateVoteNumberForTweet(e,s).then((()=>{})),n&&ninjaUserObj.tw_id){const e=i18next.t("slogan_1")+gameContractMeta.totalBonus+" ETH. "+i18next.t("voter-slogan");await __shareVoteToTweet(o,a,e)}reloadSelfNjData().then((()=>{})),loadUserPointsInfos().then((e=>{console.log("load user points success")})),t&&t(s)}))})):showDialog(DLevel.Warning,"can't vote to unpaid tweet")}async function updateVoteStatusToSrv(e,t,o){return await PostToSrvByJson("/updateTweetVoteStatus",{create_time:e,vote_count:Number(t),tx_hash:o})}async function withdrawAction(e){try{showWaiting("prepare transaction");const t=await e.withdraw("0x00",!0);changeLoadingTips("transaction packaging:"+t.hash);const o=await t.wait();showDialog(DLevel.Success,(o.status,"success"))}catch(e){checkMetamaskErr(e)}finally{hideLoading()}}async function showTargetTweetDetail(){if(!targetTweet||!targetTweet.create_time)return;await showTweetDetail("tweets-park",targetTweet);const e=window.location.protocol+"//"+window.location.host+"/main";history.pushState(null,"",e)}async function reloadSelfNjData(){let e;try{e=await GetToSrvByJson("/refreshNjUser"),ninjaUserObj=e,await setupUserBasicInfoInSetting()}catch(e){console.log(e),showDialog(DLevel.Warning,"reload session failed:"+e.toString())}}function showTmpTips(e){const t=document.getElementById("temporary-alert-popup");t.className="temporary-alert-popup show",t.querySelector(".tips-content-msg").innerText=e,setTimeout((function(){t.className=t.className.replace("show","")}),3e3)}window.onscroll=function(){throttle(contentScroll,200)};