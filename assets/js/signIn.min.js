window.addEventListener("resize",(function(){const e=document.querySelector(".container"),t=window.innerWidth-e.getBoundingClientRect().right;e.style.right=t<=300?"300px":"20vw"}));class SignInData{constructor(e,t,n,o){this.eth_addr=e,this.referrer_code=t,this.referrer_id=o,this.sign_time=n||(new Date).getTime()}}function showError(e){if(!e||0===e.length)return document.getElementById("error-txt").textContent="",void(document.getElementById("error-div").style.display="none");document.getElementById("error-txt").textContent=e,document.getElementById("error-div").style.display="block"}async function showSignBtn(e){document.querySelectorAll(".logo-container").forEach((e=>e.classList.remove("active")));const t=document.getElementById("web3-id-tips"),n=document.getElementById("sign-in-div"),o=document.getElementById("metamask-div"),r=document.getElementById("web3-id"),i=document.querySelector(".referral-code-popup");if(!e)return t.style.display="block",n.style.display="none",o.style.display="block",r.style.display="none",i.style.display="none",void showError(null);t.style.display="none",n.style.display="block",o.style.display="none",r.style.display="block",r.textContent=e,document.getElementById("logo-container-arbitrum").classList.add("active"),document.getElementById("logo-container-eth").classList.add("active");const s=await loadNJUserInfoFromSrv(e);if(!s)return void(i.style.display="block");s.referrer_code?i.style.display="none":i.style.display="block",await TwitterBasicInfo.loadTwBasicInfo(s.tw_id)&&document.getElementById("logo-container-twitter").classList.add("active")}async function initPageElem(){if(await initDatabase(),void 0!==window.ethereum){window.ethereum.on("accountsChanged",(async function(e){showError(null),e.length>0?await showSignBtn(e[0]):await showSignBtn(null)}));try{const e=await window.ethereum.request({method:"eth_accounts"});if(0===e.length)return void await showSignBtn(null);await showSignBtn(e[0])}catch(e){console.error("Error checking MetaMask status:",e),showError(e)}}else await showSignBtn(null)}function closeReferralCode(){document.querySelector(".referral-code-popup").style.display="none"}async function setupReferralCode(){const e=document.getElementById("referral-code-val"),t=e.value;if(t.length!==referrerCodeLen)return void showDialog(DLevel.Tips,"referral code length is:"+referrerCodeLen);showWaiting("checking referral code");const n=await loadNJUserByReferrer(t);if(!n)return showDialog(DLevel.Tips,"no such referrer!"),document.getElementById("referral-code-val").value="",void hideLoading();hideLoading();const o=document.getElementById("web3-id").textContent;n.eth_addr!==o?(document.querySelector(".referral-code-popup").style.display="none",e.dataset.ethAddr=n.eth_addr):showDialog(DLevel.Tips,"Referrer should not be yourself")}async function connectToMetamask(){if(window.ethereum&&window.ethereum.isMetaMask)try{const e=await window.ethereum.request({method:"eth_requestAccounts"});await showSignBtn(e[0])}catch(e){if(console.error("Metamask login failed:",e.code,e.message.toString()),-32002===e.code)return void showError("Please click the metamask plugin and sign in ");showError(e.message)}else window.open("https://metamask.io/download/","_blank")}async function signInByEth(){showError(null);const e=document.getElementById("web3-id").textContent;if(e.length<20)return void showError("no valid web3 id selected");const t=document.getElementById("referral-code-val"),n=t.value,o=new SignInData(e);n.length===referrerCodeLen&&(o.referrer_code=n,o.referrer_id=t.dataset.ethAddr);const r=JSON.stringify(o);try{const t=await window.ethereum.request({method:"personal_sign",params:[r,e]});showWaiting("signing in......",15);const n=new SignDataForPost(r,t,null);PostToSrvByJson("/signInByEth",n).then((e=>{console.log("sign in by eth success",e),hideLoading(),e?window.location.href="/main":showError("failed to load ninja user data")})).catch((e=>{showError(e.toString()),hideLoading()}))}catch(e){showError("sign in err:\n"+e.message),hideLoading()}}function showAppList(e,t){document.getElementById(e).style.display=t?"none":"block"}document.addEventListener("DOMContentLoaded",initPageElem);