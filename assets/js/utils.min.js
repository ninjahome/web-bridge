function formatTime(e){const t=new Date(e);return`${t.getHours().toString().padStart(2,"0")}:${t.getMinutes().toString().padStart(2,"0")}:${t.getSeconds().toString().padStart(2,"0")} ${t.getDate().toString().padStart(2,"0")}/${(t.getMonth()+1).toString().padStart(2,"0")}`}let CountdownTargetTime=0;function resetCounter(e){CountdownTargetTime=e}function startCountdown(e){return setInterval((()=>{const t=(new Date).getTime(),n=CountdownTargetTime-t;if(n<=0)return void e("","","","",!0);const o=Math.floor(n/864e5);let r=Math.floor(n%864e5/36e5),a=Math.floor(n%36e5/6e4),i=Math.floor(n%6e4/1e3);r=r<10?"0"+r:r,a=a<10?"0"+a:a,i=i<10?"0"+i:i,e(o,r,a,i,!1)}),1e3)}async function fetchFromSrv(e,t){const n=document.getElementById("csrf_token");n&&(t.headers["X-CSRF-Token"]=n.value);try{const n=await fetch(e,t);if(n.redirected)return void(window.location=n.url);if(!n.ok){if([301,302,303,307,308].includes(n.status))return void(window.location=n.url);await handleFetchError(n)}return"0"!==n.headers.get("Content-Length")&&n.headers.get("Content-Type").includes("application/json")?await n.json():null}catch(e){if(console.error("Error during fetch:",e),!e.toString().includes("NetworkError"))throw e}}async function handleFetchError(e){const t=await e.text();if(403!==e.status)throw console.error("Server responded with an error:",e.status,t),new Error("Server responded with an error: "+e.status);try{const e=JSON.parse(t);throw"CSRF token invalid"===e.reason?(console.error("CSRF token is invalid or missing."),window.location.href="/signIn"):console.error("Access denied: "+e.message),new Error("403 Forbidden: "+e.message)}catch(e){console.error("Failed to parse error details",e)}}async function PostToSrvByJson(e,t){return fetchFromSrv(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})}async function GetToSrvByJson(e){return fetchFromSrv(e,{method:"GET",headers:{"Content-Type":"application/json"}})}const __globalMetaMaskNetworkParam=new Map([[toHex(42161),{chainId:toHex(42161),chainName:"Arbitrum One",nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},rpcUrls:["https://1rpc.io/arb"],blockExplorerUrls:["https://arbiscan.io"]}],[toHex(421613),{chainId:toHex(421613),chainName:"Arbitrum Goerli",nativeCurrency:{name:"AETH",symbol:"AETH",decimals:18},rpcUrls:["https://endpoints.omniatech.io/v1/arbitrum/goerli/public"],blockExplorerUrls:["https://goerli.arbiscan.io"]}],[toHex(421614),{chainId:toHex(421614),chainName:"Arbitrum Sepolia",nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},rpcUrls:["https://sepolia-rollup.arbitrum.io/rpc"],blockExplorerUrls:["https://sepolia.arbiscan.io"]}],[toHex(5777),{chainId:toHex(5777),chainName:"loaclTest",nativeCurrency:{name:"ETH",symbol:"ETH",decimals:18},rpcUrls:["HTTP://192.168.1.122:7545"],blockExplorerUrls:[""]}]]);class SignDataForPost{constructor(e,t,n){this.message=e,this.signature=t,this.pay_load=n}}function createModalElement(){const e=document.createElement("div");e.id="loading-modal",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.backgroundColor="rgba(0, 0, 0, 0.3)",e.style.zIndex="10000";const t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.background="rgb(255,255,255,1)",t.style.padding="20px",t.style.borderRadius="5px";const n=document.createElement("div");n.id="loading-spinner",n.style.border="6px solid #DDDDDE",n.style.borderTop="6px solid #4EA0F2",n.style.borderRadius="50%",n.style.width="40px",n.style.height="40px",n.style.animation="spin 2s ease-in-out infinite";const o=document.createElement("div");o.id="loading-message",o.style.marginTop="10px",o.textContent=" ";const r=document.createElement("div");return r.textContent=" ",r.style.position="absolute",r.style.top="48.75%",r.style.left="50%",r.style.transform="translate(-50%, -50%)",r.style.fontSize="10px",r.style.color="#4EA0F2",t.appendChild(r),t.appendChild(n),t.appendChild(o),e.appendChild(t),e}const style=document.createElement("style");style.type="text/css",style.innerHTML="\n    @keyframes spin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n    }\n",document.head.appendChild(style);let isShowingTips=!1;function showWaiting(e,t){if(isShowingTips)return void changeLoadingTips(e);isShowingTips=!0;const n=createModalElement();document.body.appendChild(n);document.getElementById("loading-message").textContent=e,t&&setTimeout((()=>{n&&document.body.removeChild(n)}),1e3*t)}function changeLoadingTips(e){const t=document.getElementById("loading-message");t&&(t.textContent=e)}function hideLoading(){if(!isShowingTips)return;isShowingTips=!1;const e=document.getElementById("loading-modal");e&&document.body.removeChild(e)}function lclDbKeyForTwitterUserData(e){return"__database_key_for_twitter_user_data__:"+e}function DbKeyForNjUserData(e){return"__database_key_for_ninja_user_data__:"+e}function clearSessionStorage(){sessionStorage.clear()}function lclDbKeyForBlockChainData(e){return"__local_database_key_for_block_chain_data__:"+e}class TwitterBasicInfo{constructor(e,t,n,o,r){this.id=e,this.name=t,this.username=n,this.profile_image_url=o,this.description=r}static async loadTwBasicInfo(e){const t=await getItemWithTimestamp(lclDbKeyForTwitterUserData(e));if(!t)return null;const n=JSON.parse(t);return new TwitterBasicInfo(n.id,n.name,n.username,n.profile_image_url,n.description)}static cacheTwBasicInfo(e){if(!e.id)throw new Error("invalid twitter basic info");return setItemWithTimestamp(lclDbKeyForTwitterUserData(e.id),JSON.stringify(e)),e}}class NJUserBasicInfo{constructor(e,t,n,o,r,a,i,s,c,l,d){this.address=e,this.eth_addr=t,this.create_at=n,this.tw_id=o,this.update_at=r,this.tweet_count=a,this.vote_count=i,this.be_voted_count=s,this.is_elder=c,this.referrer_code=l,this.self_ref_code=d}static async loadNjBasic(e){const t=await getItemWithTimestamp(DbKeyForNjUserData(e.toLowerCase()));if(!t)return null;const n=JSON.parse(t);return new NJUserBasicInfo(n.address,n.eth_addr,n.create_at,n.tw_id,n.update_at,n.tweet_count,n.vote_count,n.be_voted_count,n.is_elder,n.referrer_code,n.self_ref_code)}static cacheNJUsrObj(e){if(!e.eth_addr)throw new Error("invalid twitter basic info");setItemWithTimestamp(DbKeyForNjUserData(e.eth_addr.toLowerCase()),JSON.stringify(e))}static cacheNJUsrObjByReferrer(e){if(!e.self_ref_code)throw new Error("invalid twitter basic info");setItemWithTimestamp(DbKeyForNjUserData(e.self_ref_code.toLowerCase()),JSON.stringify(e))}}const DLevel=Object.freeze({Tips:1,Warning:2,Error:3,Success:4});function createDialogElement(e){const t=document.createElement("div");return t.id="custom-dialog",t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.display="flex",t.style.justifyContent="center",t.style.alignItems="center",t.style.backgroundColor="rgba(0, 0, 0, 0.5)",t.style.zIndex="10000",t.innerHTML=`\n        <div style="background: white; padding: 24px 32px; border-radius: 8px; text-align: center;">\n             <img src="${e}" alt="dialog image" style="max-width: 100%; height: auto; margin-bottom: 2px">\n            <p id="dialog-message" style="margin-top: 0; margin-bottom: 16px">Message</p>\n            <div style="display: flex; flex-direction: row; justify-content: center">\n                <button id="dialog-close" style="margin:0 8px; padding: 8px 42px; border-radius: 12px; background-color: transparent; border: 1px solid rgb(221, 221, 222);font-size: 14px; color: #7E7F82">关闭</button>\n                <button id="dialog-confirm" style="margin:0 8px; padding: 8px 42px; border-radius: 12px; border: none;font-size: 14px; color: #ffffff; background-color: #4EA0F2">确定</button>\n            </div>\n        </div>\n        `,t}function showDialog(e,t,n,o){let r;switch(hideLoading(),e){case DLevel.Tips:r="/assets/file/info-img.png";break;case DLevel.Error:r="/assets/file/error-img.png";break;case DLevel.Warning:r="/assets/file/warning-img.png";break;case DLevel.Success:r="/assets/file/success-img.png"}const a=createDialogElement(r);document.body.appendChild(a);const i=document.getElementById("dialog-message"),s=document.getElementById("dialog-close"),c=document.getElementById("dialog-confirm");i.textContent=t,s.addEventListener("click",(function(){document.body.removeChild(a),o&&o()})),n?(c.style.display="block",c.addEventListener("click",(function(){document.body.removeChild(a),n()}))):c.style.display="none"}async function checkIfMetaMaskSignOut(){return 0!==(await window.ethereum.request({method:"eth_accounts"})).length||(window.location.href="/signIn",!1)}async function checkMetaMaskEnvironment(e){if(void 0===window.ethereum)return void(window.location.href="/signIn");if(!1===await checkIfMetaMaskSignOut())return;window.ethereum.on("accountsChanged",metamaskAccountChanged),window.ethereum.on("chainChanged",(function(t){checkCurrentChainID(t,e)}));const t=await window.ethereum.request({method:"eth_chainId"});await checkCurrentChainID(t,e)}function metamaskAccountChanged(e){if(0===e.length)return console.log("MetaMask账户已断开连接，请重新连接"),void(window.location.href="/signIn");window.location.href="/signIn"}async function checkCurrentChainID(e,t){if(__globalTargetChainNetworkID!==e)return void showDialog(DLevel.Tips,"switch to arbitrum",switchToWorkChain,(function(){window.location.href="/signIn"}));const n=new ethers.BrowserProvider(window.ethereum);t&&await t(n)}async function switchToWorkChain(){(await switchChain(__globalTargetChainNetworkID)).needAdd&&await addChain(__globalTargetChainNetworkID)}async function switchChain(e){try{return await window.ethereum.request({method:"wallet_switchEthereumChain",params:[{chainId:e}]}),location.reload(),{switched:!0,needAdd:!1}}catch(e){return 4902===e.code?{switched:!1,needAdd:!0}:(showDialog(DLevel.Error,"Failed switching to Arbitrum network"),{switched:!1,needAdd:!1})}}async function addChain(e){try{const t=__globalMetaMaskNetworkParam.get(e);await window.ethereum.request({method:"wallet_addEthereumChain",params:[t]}),location.reload()}catch(e){showDialog(DLevel.Error,"Add to network failed: "+e.toString())}}let confirmCallback=null;function openVoteModal(e){document.getElementById("vote-no-chose-modal").style.display="block";document.getElementById("voteCountInChoseModal").value=1,confirmCallback=e}function confirmVoteModal(){if(confirmCallback){const e=document.getElementById("voteCountInChoseModal").value,t=document.getElementById("shareOnTwitter").checked;confirmCallback(e,t)}closeVoteModal()}function closeVoteModal(){document.getElementById("vote-no-chose-modal").style.display="none"}function increaseVote(){const e=document.getElementById("voteCountInChoseModal");e.value=parseInt(e.value)+1}function decreaseVote(){const e=document.getElementById("voteCountInChoseModal"),t=Math.max(1,parseInt(e.value)-1);e.value=t.toString()}async function __shareVoteToTweet(e,t,n){await PostToSrvByJson("/shareVoteAction",{create_time:e,vote_count:Number(t),slogan:n})}async function loadNJUserInfoFromSrv(e,t=!0){try{if(!t){const t=await GetToSrvByJson("/queryNjBasicByID?web3_id="+e.toLowerCase());return t?(NJUserBasicInfo.cacheNJUsrObj(t),t):null}let n=await NJUserBasicInfo.loadNjBasic(e);return n||(n=await GetToSrvByJson("/queryNjBasicByID?web3_id="+e.toLowerCase()),n&&NJUserBasicInfo.cacheNJUsrObj(n),n)}catch(e){return console.log("queryTwBasicById err:",e),null}}async function loadNJUserByReferrer(e,t=!0){try{if(!t){const t=await GetToSrvByJson("/queryNjBasicByReferrer?referrer_code="+e.toLowerCase());return t?(NJUserBasicInfo.cacheNJUsrObjByReferrer(t),t):null}let n=await NJUserBasicInfo.loadNjBasic(e);return n||(n=await GetToSrvByJson("/queryNjBasicByReferrer?referrer_code="+e.toLowerCase()),n&&NJUserBasicInfo.cacheNJUsrObjByReferrer(n),n)}catch(e){return console.log("queryTwBasicById err:",e),null}}function checkMetamaskErr(e){if(console.error("Transaction error: ",e),hideLoading(),-32603===e.code||"Internal JSON-RPC error."===e.message)return showDialog(DLevel.Warning,"metamask invalid right now."),null;if(4001===e.code||"ACTION_REJECTED"===e.code)return null;if(4100===e.code)return showDialog(DLevel.Warning,"open metamask first"),null;if(-32603===e.code)return showDialog(DLevel.Warning,"check your metamask please"),null;let t=e.code;return"CALL_EXCEPTION"!==t||"estimateGas"!==e.action||e.reason?(e.data&&e.data.message?t="code:"+e.data.code+" "+e.data.message:t?t+=e.message:t=e.message,t.includes("duplicate post")?t:t.includes("insufficient funds")?(showDialog(DLevel.Warning,"insufficient funds"),null):(showDialog(DLevel.Warning,t),t)):(showDialog(DLevel.Warning,"insufficient funds"),null)}function __incomeWithdrawHistory(e){let t=__globalMetaMaskNetworkParam.get(__globalTargetChainNetworkID).blockExplorerUrls[0];t+="/address/"+e,t+="#internaltx",window.open(t)}function adjustImageToApproxTargetBase64Length(e,t){return new Promise(((n,o)=>{if(!e.complete)return void o("Image has not loaded yet.");const r=e.src.length,a=.95*Math.sqrt(t/r),i=Math.floor(e.width*a),s=Math.floor(e.height*a);compressAndResizeImage(e,i,s,.8).then((r=>{r.length>t?compressAndResizeImage(e,i,s,.8*.8).then((e=>{n(e)})).catch(o):n(r)})).catch(o)}))}function compressAndResizeImage(e,t,n,o){return new Promise(((r,a)=>{const i=document.createElement("canvas"),s=i.getContext("2d");i.width=t,i.height=n,s.drawImage(e,0,0,t,n);try{r(i.toDataURL("image/jpeg",o))}catch(e){a(e)}}))}function readFileAsBlob(e){return new Promise(((t,n)=>{const o=new FileReader;o.onload=e=>{const o=new Image;o.onload=()=>{t(o)},o.onerror=e=>{n(e)},o.src=e.target.result},o.onerror=e=>{n(e)},o.readAsDataURL(e)}))}function safeSubstring(e,t){if(t>=e.length)return e;let n=e.match(/[\u4e00-\u9fa5]|\s+|[a-zA-Z0-9]+|[\uff00-\uffff]/g),o=0,r=0;for(let e=0;n&&e<n.length&&o<t;e++){let a=n[e],i=Array.from(a).length;if(o+i>t)break;o+=i,r+=a.length}return e.substring(0,r)}function setItemWithTimestamp(e,t){const n=new CacheItem(e,t);databaseAddOrUpdate(__constCachedItem,n).then((e=>{})).catch((e=>{console.log(e)}))}async function getItemWithTimestamp(e){try{const t=await databaseGetByID(__constCachedItem,e);if(t)return t.data;console.log("No data found for this key")}catch(e){return console.error("Query failed:",e),null}}class CacheItem{constructor(e,t){this.key=e,this.data=t}}const __defaultLogo="/assets/file/logo.png",maxTweetLenPerPage=500,maxImgPerTweet=4,defaultTextLenForTweet=280,MaxRawImgSize=1048448,MaxThumbnailSize=1<<17,TimeIntervalForBlockChain=30,MaxTweetsPerPost=5,delimiter=",",referrerCodeLen=6;