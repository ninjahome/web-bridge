const cachedGlobalTweets=new MemCachedTweets;function bindingTwitter(){showWaiting("prepare to bind twitter"),window.location.href="/signUpByTwitter"}async function __loadTweetsAtHomePage(e){try{const t=new TweetQueryParam(0,"",[]);await TweetsQuery(t,e,cachedGlobalTweets)&&(await fillTweetParkAtHomePage(e),cachedGlobalTweets.CachedItem=[])}catch(e){console.log(e),showDialog(DLevel.Error,"failed to load tweets")}}async function loadTweetsForHomePage(){document.getElementById("tweets-park").style.display="block",document.getElementById("tweet-post-on-top").style.display="block",showWaiting("loading....."),await __loadTweetsAtHomePage(!0),hideLoading()}async function loadOlderTweetsForHomePage(){if(0!==cachedGlobalTweets.latestID)return __loadTweetsAtHomePage(!1);console.log("no need to load older data")}async function loadTwitterUserInfoFromSrv(e,t,n){try{if(n&&(t=!1),t){let t=await TwitterBasicInfo.loadTwBasicInfo(e);if(t)return t}const o=await GetToSrvByJson("/queryTwBasicById?twitterID="+e+"&&forceSync="+n);return o?TwitterBasicInfo.cacheTwBasicInfo(o):null}catch(e){return console.log("queryTwBasicById err:",e),null}}async function __fillNormalTweet(e,t,n,o,a,i,r,s){const l=document.getElementById(t);e&&(l.innerHTML="");for(const e of n){const n=document.getElementById(o).cloneNode(!0);n.style.display="",n.id=a+e.create_time,n.dataset.createTime=e.create_time;const c=document.getElementById("tweet-header-template").cloneNode(!0);c.style.display="",c.id="";const d=n.querySelector(".tweet-footer"),w=await setupCommonTweetHeader(c,e,i);TweetDetailSource.NoNeed!==r&&(w.onclick=()=>showTweetDetail(t,e)),n.insertBefore(c,d),s&&s(n,c,e),l.appendChild(n);const g=n.querySelector(".show-more");w.scrollHeight<=w.clientHeight?g.style.display="none":(g.textContent=i18next.t("tweet-show-more"),g.style.display="block")}}async function fillTweetParkAtHomePage(e){return __fillNormalTweet(e,"tweets-park",cachedGlobalTweets.CachedItem,"tweetTemplateForHomePage","tweet-card-for-home-",!0,TweetDetailSource.HomePage,(function(e,t,n){e.querySelector(".vote-number").textContent=n.vote_count,__showVoteButton(e,n)}))}async function convertTweetContentToImg(e,t="image/jpeg",n=1){try{const o=document.getElementById("hidden-tweet-for-img"),a=document.getElementById("hidden-tweet-txt");a.innerText=e;const i=(await html2canvas(o,{dpi:300,scale:2})).toDataURL(t,n);return a.innerText="",i}catch(e){console.log(e)}}function getCompositedTxt(e,t,n){let o=safeSubstring(e,defaultTextLenForTweet-4-n)+"...",a=o+t;return twttr.txt.getTweetLength(a)>defaultTextLenForTweet&&(o=safeSubstring(e,(defaultTextLenForTweet-4-n)/2)+"...",a=o+t),a}async function convertContentToImages(e,t){let n=e;for(let e=0;e<maxImgPerTweet;e++){const o=n.substring(0,maxTweetLenPerPage),a=await convertTweetContentToImg(o);if(t.push(new ImageRawData("converted-"+e,a,"")),n=n.substring(o.length),o.length<maxTweetLenPerPage)break}}function parseTweetContent(e){const t=e.querySelectorAll(".tweets-content-txt-area"),n=Array.from(t).map((e=>{const t=e.firstChild;if(!t)throw new Error("tweet content is empty");let n=t.textContent.replace(/\u200B/g,"").trim();if(!1===/\S/.test(n))throw new Error("tweet content is empty");return n})).filter((e=>e&&e.length>0));if(0===n.length)return showDialog(DLevel.Warning,"content too short"),null;if(n.length>MaxTweetsPerPost+1)return showDialog(DLevel.Warning,"content too long"),null;const o=e.querySelectorAll(".img-wrapper-container"),a=Array.from(o).map((e=>{let t=e.querySelectorAll("img");return t.length>maxImgPerTweet&&(t=t.slice(0,maxImgPerTweet)),Array.from(t).map((e=>{const t=e.src,n=e.getAttribute("data-raw"),o=e.getAttribute("data-hash");return new ImageRawData(o,n,t)}))}));let i="";for(let e=0;e<n.length;e++){const t=a[e];if(i+=n[e],0===t.length){i+="\n\n";continue}let o="<dessage-img>";t.forEach(((e,t)=>{o+=e.hash+delimiter})),o.endsWith(delimiter)&&(o=o.slice(0,-1)),i+=o+"</dessage-img>\n"}return{formattedTxt:i,txtList:n,imageList:a}}function initSloganTxt(e){return"\n"+i18next.t("slogan_1")+gameContractMeta.totalBonus+i18next.t("slogan_2")+"https://"+window.location.hostname+"/buyRights?NjTID="+e}async function preparePostMsg(e){const t=parseTweetContent(e);if(!t||0===t.txtList.length)return null;const n=(new Date).getTime(),o=initSloganTxt(n),a=t.txtList.length-1,i=t.txtList[a];!0===twttr.txt.parseTweet(i+o).valid?t.txtList[a]+=o:(t.txtList.push(o),t.imageList.push([]));const r=new TweetContentToPost(t.formattedTxt,t.txtList,n,ninjaUserObj.eth_addr,ninjaUserObj.tw_id),s=JSON.stringify(r),l=await window.ethereum.request({method:"personal_sign",params:[t.formattedTxt,ninjaUserObj.eth_addr]});return l?new SignDataForPost(s,l,JSON.stringify(t.imageList)):(showDialog(DLevel.Warning,"empty signature"),null)}function updatePaymentStatusToSrv(e,t){return PostToSrvByJson("/updateTweetPaymentStatus",{create_time:e.create_time,status:e.payment_status,hash:e.prefixed_hash,tx_hash:t}).then((e=>{console.log(e)}))}async function postTweetWithPayment(e){if(ninjaUserObj.tw_id)try{const t=document.querySelector(e);showWaiting("preparing dessage");const n=await preparePostMsg(t);if(!n)return;closePostTweetDiv(),showWaiting("posting to twitter");const o=await PostToSrvByJson("/postTweet",n);if(!o)return;clearDraftTweetContent(t),await procPaymentForPostedTweet(o,(async function(e,t){await updatePaymentStatusToSrv(e,t),0===curScrollContentID?__loadTweetsAtHomePage(!0).then((()=>{})):2===curScrollContentID&&__loadTweetAtUserPost(!0,ninjaUserObj.eth_addr).then((()=>{}))}))}catch(e){checkMetamaskErr(e)}finally{hideLoading()}else showDialog(DLevel.Warning,"bind twitter first",bindingTwitter)}async function showPostTweetDiv(){if(!voteContractMeta)return void showDialog(DLevel.Warning,"please change metamask to arbitrum network");if(!ninjaUserObj.tw_id)return void showDialog(DLevel.Warning,"bind twitter first",bindingTwitter);initTweetArea("modal-split-tweet-content");document.querySelector(".modal-for-tweet-post").style.display="block",document.getElementById("modal-overlay").style.display="block";document.getElementById("tweet-post-with-eth-btn-txt-2").innerText=i18next.t("btn-tittle-post-tweet")+"("+voteContractMeta.votePriceInEth+" eth)"}function closePostTweetDiv(){document.querySelector(".modal-for-tweet-post").style.display="none",document.getElementById("modal-overlay").style.display="none"}function clearDraftTweetContent(e){const t=e.querySelector(".split-tweet-content");t.innerHTML="",__globalTweetEditorCount=0,newSplitEditor(t)}function showFullTweetContent(){const e=this.closest(".tweet-card"),t=e.querySelector(".tweet-content");"true"===this.getAttribute("data-more")?(t.style.display="block",t.classList.remove("tweet-content-collapsed"),e.style.maxHeight="none",this.innerText=i18next.t("tweet-show-less"),this.setAttribute("data-more","false")):(t.style.display="-webkit-box",t.classList.add("tweet-content-collapsed"),this.setAttribute("data-more","true"),this.innerText=i18next.t("tweet-show-more"))}function loadImgFromLocal(){if(!ninjaUserObj.tw_id)return void showDialog(DLevel.Warning,"bind twitter first",bindingTwitter);const e=this.closest(".tweet-split-item");e.querySelectorAll(".img-wrapper-container img").length>=maxImgPerTweet?showDialog(DLevel.Tips,"max "+maxImgPerTweet+" images allowed"):e.querySelector(".tweet-file-input").click()}function previewImage(){const e=this.parentNode;let t=e.querySelector(".tweet-file-input").files;const n=e.querySelector(".img-wrapper-container");n.style.display="block";const o=n.querySelectorAll("img"),a=maxImgPerTweet-o.length;a<=0||(t.length>a&&showTmpTips("max "+maxImgPerTweet+" images allowed"),t=Array.from(t).slice(0,a),t.forEach((e=>{const t=document.getElementById("img-wrapper-template").cloneNode(!0);t.style.display="block",t.setAttribute("id","");const o=t.querySelector(".img-preview");t.querySelector(".delete-btn").onclick=function(){n.removeChild(t),0===n.querySelectorAll("img").length&&(n.style.display="none")},readFileAsBlob(e).then((async e=>{let a=e.src;a.length>MaxRawImgSize&&(a=await adjustImageToApproxTargetBase64Length(e,MaxRawImgSize)),o.setAttribute("data-raw",a);const i=ethers.hashMessage(a);o.setAttribute("data-hash",i),e.src.length>MaxThumbnailSize?o.src=await adjustImageToApproxTargetBase64Length(e,MaxThumbnailSize):o.src=e.src,n.appendChild(t)}))})),e.querySelector(".tweet-file-input").value="")}function initTweetArea(e){const t=document.getElementById(e);__globalTweetEditorCount=0,t.innerHTML="",newSplitEditor(t)}function addNextSplitEditor(e){newSplitEditor(e.closest(".split-tweet-content"),e.closest(".tweet-split-item"))}let __globalTweetEditorCount=0;function newSplitEditor(e,t){if(__globalTweetEditorCount>=MaxTweetsPerPost)return void showDialog(DLevel.Warning,"too much tweets");const n=document.getElementById("tweet-split-item-template").cloneNode(!0);n.style.display="block",n.id="tweet-area-"+__globalTweetEditorCount;const o=n.querySelector(".tweets-content-txt-area");o.innerHTML="",o.addEventListener("compositionstart",(()=>{isComposing=!0})),o.addEventListener("compositionend",(()=>{isComposing=!1,checkTweetLength(o)})),o.addEventListener("input",(()=>{ninjaUserObj.tw_id?isComposing||checkTweetLength(o):showDialog(DLevel.Warning,"bind twitter first",bindingTwitter)})),o.addEventListener("keydown",handleEnter),__globalTweetEditorCount++,t?t.insertAdjacentElement("afterend",n):e.appendChild(n)}let isComposing=!1;function delCurrentEditor(e){if(1===__globalTweetEditorCount)return;e.closest(".tweet-split-item").remove(),__globalTweetEditorCount--}function checkSelection(){if(window.getSelection){const e=window.getSelection().toString();console.log("Selected text: ",e)}}function checkTweetLength(e,t=!1){const n=e.innerText,o=twttr.txt.parseTweet(n);let a=n.substring(0,o.validRangeEnd+1),i=n.substring(o.validRangeEnd+1),r=saveCaretPosition(e);for(;e.firstChild;)e.removeChild(e.firstChild);let s=document.createTextNode(a);if(e.appendChild(s),i){let t=document.createElement("span");t.className="tweet-over-flow-red",t.innerText=i,e.appendChild(t)}r(t);e.closest(".tweet-split-item").querySelector(".tweet-length-valid").innerText=280-o.weightedLength}function handlePaste(e){e.preventDefault();insertTextAtCursor((e.clipboardData||window.clipboardData).getData("text/plain")),checkTweetLength(e.target)}function insertTextAtCursor(e){const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();const o=e.split("\n"),a=document.createDocumentFragment();o.forEach(((e,t)=>{t>0&&a.appendChild(document.createElement("br")),a.appendChild(document.createTextNode(e))})),n.insertNode(a),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}function saveCaretPosition(e){let t=window.getSelection();if(0===t.rangeCount)return()=>{};let n=t.getRangeAt(0),o=document.createRange();o.setStart(e,0),o.setEnd(n.startContainer,n.startOffset);let a=o.toString().length;return function(n){t.removeAllRanges();let o,i=document.createRange(),r=[e],s=a;for(n&&s++;o=r.pop();)if(3===o.nodeType){if(s<=o.length){i.setStart(o,s);break}s-=o.length}else{let e=o.childNodes.length;for(;e--;)r.push(o.childNodes[e])}i.startContainer&&i.startContainer.parentNode?(i.collapse(!0),t.addRange(i)):console.warn("Range not in document, cannot restore caret position")}}function handleEnter(e){if("Enter"===e.key){e.preventDefault();const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);n.deleteContents();document.createElement("br");n.insertNode(document.createTextNode("​")),n.insertNode(document.createElement("br")),t.removeAllRanges(),t.addRange(n),checkTweetLength(e.target,!0)}}