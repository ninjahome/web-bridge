let lotteryGameContract=null,gameSettings=null,personalData=null;document.addEventListener("DOMContentLoaded",initGamePage);class GameSettings{constructor(t,e,n,o,a,i){this.roundNo=t,this.bonus=e,this.tickPrice=o,this.tickPriceInEth=a,this.isOpen=i,this.voteNo=n}}class GameRoundInfo{constructor(t,e,n,o,a,i,r,s){this.hash=t,this.dTime=e,this.winner=n,this.winTicketID=o,this.curBonus=a,this.random=i,this.bonusForWinner=r,this.ticketsNo=s}static fromBlockChainObj(t){const e=ethers.formatUnits(t.bonus,"ether"),n=1e3*Number(t.discoverTime),o=ethers.formatUnits(t.bonusForWinner,"ether");return new GameRoundInfo(t.randomHash,n,t.winner,t.winTicketID,e,t.randomVal,o,Number(t.ticketNo))}}class WinTeamInfo{constructor(t,e,n,o,a,i,r){this.round_no=t,this.win_team=e,this.bonus=n,this.member_addr=o,this.member_vote_no=a,this.total_vote_no=i,this.total_mem_no=r}}class PersonalData{constructor(t,e,n){this.balance=t,this.tickets=e,this.tickMap=n}}async function initGamePage(){try{await checkMetaMaskEnvironment(initGameContract);const t=__globalContractConf.get(__globalTargetChainNetworkID).gameLottery;document.querySelector(".contract-address-value").textContent=t,showWaiting("loading from blockchain"),await __loadPageData(),syncWinnerHistoryData().then((t=>{})),initGamingCounter()}catch(t){console.log(t),showDialog(DLevel.Warning,"load game settings from block chain failed")}finally{hideLoading()}}function showContractUrl(){const t=__globalContractConf.get(__globalTargetChainNetworkID).gameLottery,e=__globalMetaMaskNetworkParam.get(__globalTargetChainNetworkID).blockExplorerUrls;window.open(e+"/address/"+t)}async function initGameContract(t){if(!t)return void(lotteryGameContract=null);const e=await t.getSigner(ninjaUserObj.eth_addr),n=__globalContractConf.get(__globalTargetChainNetworkID);lotteryGameContract=new ethers.Contract(n.gameLottery,gameContractABI,e)}async function __loadPageData(){await loadGameSettings(),await setupCurrentRoundData(),await loadPersonalMeta()}async function loadGameSettings(){const[t,e,n,o,a,i]=await lotteryGameContract.systemSettings(),r=ethers.formatUnits(e,"ether"),s=ethers.formatUnits(o,"ether");gameSettings=new GameSettings(t,r,n,o,s,i),document.querySelector(".history-total-bonus").textContent=gameSettings.bonus,document.querySelector(".round-number").textContent=gameSettings.roundNo,document.querySelector(".ticket-price-for-outer-user").textContent=gameSettings.tickPriceInEth}async function loadPersonalMeta(){try{const t=await lotteryGameContract.balance(ninjaUserObj.eth_addr),e=ethers.formatUnits(t,"ether");document.getElementById("personal-balance-val").textContent=e;const n=await lotteryGameContract.tickList(gameSettings.roundNo,ninjaUserObj.eth_addr);if(document.getElementById("personal-ticket-no-val").textContent=n.length,0===n.length)return void(personalData=new PersonalData(e,[],[]));const o=new Map;for(let t=0;t<n.length;t++){const e=n[t];o.set(e,!0)}personalData=new PersonalData(e,n,o)}catch(t){console.log(t),showDialog(DLevel.Warning,"load personal data from block chain failed")}}function initGamingCounter(){let t=0;const e=document.getElementById("prize-pool-discover-time");startCountdown((async function(n,o,a,i,r){e.innerText=r?i18next.t("game-status-with-draw"):n+i18next.t("game-status-day")+o+i18next.t("game-status-hour")+a+i18next.t("game-status-minute")+i+i18next.t("game-status-second"),t+=1,t<TimeIntervalForBlockChain||(t=0,await loadGameSettings(),await setupCurrentRoundData())}))}async function setupCurrentRoundData(){try{const t=await lotteryGameContract.gameInfoRecord(gameSettings.roundNo),e=GameRoundInfo.fromBlockChainObj(t);resetCounter(e.dTime),document.getElementById("prize-pool-bonus-val").textContent=e.curBonus,document.getElementById("prize-pool-random-hash").textContent=e.hash,document.getElementById("prize-pool-tick-no").textContent=gameSettings.voteNo}catch(t){console.log(t),showDialog(DLevel.Warning,"load game data from block chain failed")}}function showPersonalTicket(){if(!personalData||0===personalData.tickets.length)return;const t=document.querySelector(".user-tickets"),e="block"===t.style.display;if(t.style.display=e?"none":"block",e)return;const n=t.querySelector(".tickets-num");n.innerHTML="";let o=0,a=n.insertRow();for(let t=0;t<personalData.tickets.length;t++){o%7==0&&0!==o&&(a=n.insertRow()),a.insertCell().innerHTML=personalData.tickets[t],o++}}function hideOneTeamDetails(){document.querySelector(".team-detail-for-one").style.display="none"}function showGameRule(t){const e=document.querySelector(t);e.style.display="none"===e.style.display?"block":"none"}async function showOneRoundGameInfo(){try{const t=document.getElementById("round-input").value;if(!t)return void showDialog(DLevel.Tips,"invalid round no");document.getElementById("round-input").value="";const e=Number(t);if(e>gameSettings.roundNo)return void showDialog(DLevel.Tips,"bigger than current round no:"+gameSettings.roundNo);showWaiting("syncing from block chain");const n=await lotteryGameContract.gameInfoRecord(e);fullFillGameCard(n,document.querySelector(".round-history"),!0)}catch(t){showDialog(DLevel.Error,"failed to query form block chain:"+t.toString())}finally{hideLoading()}}function hideInfoOfThisRound(){document.querySelector(".round-history").style.display="none"}function fullFillGameCard(t,e,n){e.style.display="block",e.querySelector(".one-round-bonus-val").textContent=ethers.formatUnits(t.bonus,"ether");const o=new Date(1e3*Number(t.discoverTime));e.querySelector(".one-round-discover-val").textContent=o.toString(),e.querySelector(".history-game-random").textContent=t.randomVal,e.querySelector(".history-game-random-hash").textContent=t.randomHash,e.querySelector(".history-game-winner-address").textContent=t.winner,e.querySelector(".history-game-winner-ticket").textContent=t.winTicketID,e.querySelector(".load-history-btn").style.display=n?"block":"none"}let __toRoundNo=0;async function loadHistoryData(){try{const t=document.querySelector(".history-data-list"),e=document.querySelector(".history-data-list-more-btn");if("block"===t.style.display)return this.textContent=i18next.t("all-history-query-btn"),t.style.display="none",t.innerHTML="",void(e.style.display="none");this.textContent=i18next.t("hide-history-data-btn"),e.style.display="block",__toRoundNo=Number(gameSettings.roundNo)-1,t.style.display="block",t.innerHTML="",await __loadHistoryData(t)}catch(t){console.log(t),showDialog(DLevel.Warning,t.toString())}}async function moreHistoryData(){const t=document.querySelector(".history-data-list");t.style.display="block",await __loadHistoryData(t)}async function __loadHistoryData(t){try{if(__toRoundNo<0)return void showDialog(DLevel.Tips,"no more data");const e=__toRoundNo>20?__toRoundNo-20:0;showWaiting("syncing history game data from block chain");const n=(await lotteryGameContract.historyRoundInfo(e,__toRoundNo)).map((t=>({randomHash:t.randomHash,discoverTime:t.discoverTime,winner:t.winner,winTicketID:t.winTicketID,bonus:t.bonus,bonusForWinner:t.bonusForWinner,randomVal:t.randomVal,ticketNo:t.ticketNo})));console.log(n);let o=n.slice().reverse();for(const e of o){const n=document.getElementById("history-data-one-round-template").cloneNode(!0);fullFillGameCard(e,n),t.appendChild(n)}if(__toRoundNo=e-1,__toRoundNo<0){document.querySelector(".history-data-list-more-btn").style.display="none"}}catch(t){console.log(t),showDialog(DLevel.Warning,"load history data err:"+t.toString())}finally{hideLoading()}}async function buyTicket(){gameSettings?gameSettings.isOpen?openVoteModal(procTicketPayment):showDialog(DLevel.Tips,"not open for personal user"):showDialog(DLevel.Tips,"blockchain data need to sync, reload this page first please.")}async function procTicketPayment(t,e){if(0===t)return void showDialog(DLevel.Tips,"on ticket at lest");const n=gameSettings.tickPrice*BigInt(t);try{showWaiting("prepare to pay");const o=await lotteryGameContract.buyTicketFromOuter(t,{value:n});changeLoadingTips("packaging:"+o.hash);if(!(await o.wait()).status)return void showDialog(DLevel.Error,"transaction failed");if(await PostToSrvByJson("/updatePointsForSingleBets",{create_time:0,vote_count:Number(t),tx_hash:o.hash}),showDialog(DLevel.Success,"buy success"),e){const e=i18next.t("slogan_1")+gameSettings.bonus+" ETH. "+i18next.t("voter-slogan");__shareVoteToTweet(0,t,e).then((t=>{console.log("share to twitter success")}))}await __loadPageData()}catch(t){console.log(t),checkMetamaskErr(t)}finally{hideLoading()}}let cachedWinnerHistoryData=[],cachedWinTeamHistoryData=[];async function syncWinnerHistoryData(){const t=await GetToSrvByJson("/queryWinHistory");t&&(cachedWinnerHistoryData=t,document.querySelector(".personal-winning-count").textContent=""+cachedWinnerHistoryData.length)}function showUserWinHistory(){if(0===cachedWinnerHistoryData.length)return;const t=document.querySelector(".winner-history-list"),e="block"===t.style.display;if(t.style.display=e?"none":"block",t.innerHTML="",!e){try{for(const e of cachedWinnerHistoryData){const n=document.getElementById("winning-history-template").cloneNode(!0);n.style.display="block",n.id=null,n.querySelector(".one-round-bonus-val").textContent=e.bonus,n.querySelector(".one-round-ticket-id").textContent=e.win_ticket_id,n.querySelector(".one-round-round-val").textContent=e.round_no,n.querySelector(".one-round-discover-val").textContent=formatTime(Number(1e3*e.discover_time)),n.querySelector(".one-round-bonus-for-me").textContent=e.bonus_for_winner,t.appendChild(n)}}catch(t){console.log(t),showDialog(DLevel.Warning,"load err:"+t.toString())}syncWinnerHistoryData().then((t=>{}))}}async function withdrawBonus(){if(personalData.balance<=1e-5)showDialog(DLevel.Warning,"Insufficient Balance");else try{showWaiting("calling to block chain");const t=await lotteryGameContract.withdraw(0,!0);changeLoadingTips("packaging:"+t.hash);if(!(await t.wait()).status)return void showDialog(DLevel.Error,"transaction failed");showDialog(DLevel.Success,"withdraw success"),loadPersonalMeta().then((t=>{}))}catch(t){checkMetamaskErr(t)}finally{hideLoading()}}function incomeWithdrawHistory(){__incomeWithdrawHistory(ninjaUserObj.eth_addr)}