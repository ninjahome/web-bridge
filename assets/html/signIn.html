<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <link rel="icon" href="/assets/file/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/signIn.css">

    <script src="/assets/conf.js"></script>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/i18next.min.js"></script>
    <script src="/assets/js/database.js"></script>
    <script src="/assets/js/i18nextBrowserLanguageDetector.min.js"></script>

</head>
<body>
<div class="right-container">
    <div class="container">
        <!-- 登录部分 -->
        <div class="login-section">
            <h2 id="tittle-operation-area">获取web3ID</h2>
            <div class="web3-id-label d-radius2" id="web3-id-label">
                <strong style="margin-left: 16px; margin-bottom: 4px; display: inline-block; font-size: 14px">Web3
                    ID:</strong>
                <span id="web3-id"></span>
                <span id="web3-id-tips" class="web3-idTips">链接MetaMask以获取Web3 ID</span>
            </div>
            <div id="metamask-div">
                <button class="metamask-button" id="metamask-button" onclick="connectToMetamask()">Connect with Metamask
                </button>
            </div>
            <div id="sign-in-div">
                <button class="sign-in-button" id="sign-in-button"
                        onclick="signInByEth()">Sign In
                </button>
            </div>
        </div>
        <div id="error-div" style="display: flex; flex-direction: column; align-items: center;"><span id="error-txt"
                                                                                                      style="color: #DD324A"></span>
        </div>
        <div class="binding-section">
            <p style="color: #1B1B1D" id="title-of-bridge-list">社交元身份桥接表</p>
            <!-- Web2 绑定 -->
            <div class="web2-binding">
                <div class="title-container">
                    <h4>Web2</h4>
                </div>
                <div class="services">
                    <div class="service">
                        <img src="/assets/file/github_logo.png" alt="Web2 Logo 1">
                        <div class="logo-container" id="logo-container-github"><span class="connected-icon"></span>
                        </div>
                    </div>
                    <div class="service">
                        <img src="/assets/file/Twitter-logo.png" alt="twitter">
                        <div class="logo-container" id="logo-container-twitter"><span class="connected-icon"></span>
                        </div>
                    </div>
                    <div class="service">
                        <img src="/assets/file/Telegram-logo.png" alt="Web2 Logo 3">
                        <div class="logo-container" id="logo-container-telegram"><span class="connected-icon"></span>
                        </div>
                    </div>

                </div>
            </div>
            <!-- Web3 绑定 -->
            <div class="web3-binding">
                <div class="title-container">
                    <h4>Web3</h4>
                </div>
                <div class="services">
                    <div class="service service-nostr" style="font-size: 18px; font-weight: bold"
                         onmouseenter="showAppList('styles-nostr',false)"
                         onmouseleave="showAppList('styles-nostr',true)">
                        <img src="/assets/file/nostr.png" alt="Web2 Logo 3">
                        <div class="logo-container" id="logo-container-nostr"><span class="connected-icon"></span></div>
                    </div>
                    <div class="service service-LensProtocol" style="font-size: 18px; font-weight: bold"
                         onmouseenter="showAppList('styles-LensProtocol',false)"
                         onmouseleave="showAppList('styles-LensProtocol',true)">
                        <img src="/assets/file/LensProtocol-logo.png" alt="Web2 Logo 3">
                        <div class="logo-container" id="logo-container-lensProtocol"><span
                                    class="connected-icon"></span></div>
                    </div>
                    <div class="service service-avatars" style="font-size: 18px; font-weight: bold"
                         onmouseenter="showAppList('styles-avatars',false)"
                         onmouseleave="showAppList('styles-avatars',true)">
                        <img src="/assets/file/avatars-logo.png" alt="Web2 Logo 3">
                        <div class="logo-container" id="logo-container-avatars"><span class="connected-icon"></span>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 区块链绑定 -->
            <div class="blockchain-binding">
                <div class="title-container">
                    <h4 id="bridge-list-sub-tittle">Blockchain</h4>
                </div>
                <div class="services">
                    <div class="service">
                        <img src="/assets/file/Arbitrum-logo.png" alt="Blockchain Logo 1">
                        <div class="logo-container" id="logo-container-arbitrum"><span class="connected-icon"></span>
                        </div>
                    </div>
                    <div class="service">
                        <img src="/assets/file/Solana-logo.png" alt="Blockchain Logo 2">
                        <div class="logo-container" id="logo-container-solana"><span class="connected-icon"></span>
                        </div>
                    </div>
                    <div class="service">
                        <img src="/assets/file/Bitcoin-logo.png" alt="Blockchain Logo 2">
                        <div class="logo-container" id="logo-container-btc"><span class="connected-icon"></span></div>
                    </div>
                    <div class="service">
                        <img src="/assets/file/Ethereum-logo.png" alt="Blockchain Logo 2">
                        <div class="logo-container" id="logo-container-eth"><span class="connected-icon"></span></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="styles-avatars" id="styles-avatars">
            <ul class="styles_apps">
                <Li>
                    <img src="/assets/file/Warpcast.png">
                    <p>Warpcast</p>
                </Li>
                <Li>
                    <img src="/assets/file/supercast.png">
                    <p>Supercast</p>
                </Li>
                <Li>
                    <img src="/assets/file/farcord.png">
                    <p>Farcord</p>
                </Li>
                <Li>
                    <img src="/assets/file/yup.png">
                    <p>Yup</p>
                </Li>
            </ul>
        </div>
        <div class="styles-LensProtocol" id="styles-LensProtocol">
            <ul class="styles_apps">
                <Li>
                    <img src="/assets/file/Dumpling.png">
                    <p>Dumpling</p>
                </Li>
                <Li>
                    <img src="/assets/file/Kaira.png">
                    <p>Kaira</p>
                </Li>
                <Li>
                    <img src="/assets/file/Orb.png">
                    <p>Orb</p>
                </Li>
                <Li>
                    <img src="/assets/file/Buttrfly.png">
                    <p>Buttrfly</p>
                </Li>
                <Li>
                    <img src="/assets/file/Focalize.png">
                    <p>Focalize</p>
                </Li>
                <Li>
                    <img src="/assets/file/Hey.png">
                    <p>Hey</p>
                </Li>
            </ul>
        </div>
        <div class="styles-nostr" id="styles-nostr">
            <ul class="styles_apps">
                <Li>
                    <img src="/assets/file/rabbit.png">
                    <p>Rabbit</p>
                </Li>
                <Li>
                    <img src="/assets/file/nos.png">
                    <p>Nos</p>
                </Li>
                <Li>
                    <img src="/assets/file/coracle.png">
                    <p>Coracle</p>
                </Li>
                <Li>
                    <img src="/assets/file/damus.png">
                    <p>Damus</p>
                </Li>
                <Li>
                    <img src="/assets/file/primal.png">
                    <p>Primal</p>
                </Li>
            </ul>

        </div>
        <div style="color: #898989" class="NinjaBack">Powered By <img src="/assets/file/path-to-home-icon.png"><a
                    href="/">Ninja Protocol</a></div>
    </div>
</div>

<div class="referral-code-popup" style="display: none">
    <div class="referral-code-bgd">
        <div class="referral-code-content">
            <span class="tweet-post-close-btn" onclick="closeReferralCode()">&times;</span>
            <div style="display: flex; align-items: center">
                <h2 style="font-size: 18px" id="tittle-referral-txt">推荐码</h2>
                <span class="referralTiptext" id="tips-referral-txt">分享好用使用推荐码，将获得100积分</span>
            </div>
            <input type="text" id="referral-code-val" placeholder="请填写推荐码">
        </div>
        <button class="confirm-btn" onclick="setupReferralCode()" id="btn-referral-txt">确认</button>
    </div>
</div>
<script>
    window.addEventListener('resize', function () {
        const container = document.querySelector('.container');
        const containerRightDistance = window.innerWidth - container.getBoundingClientRect().right;
        const minRightDistance = 300;
        if (containerRightDistance <= minRightDistance) {
            container.style.right = minRightDistance + 'px';
        } else {
            container.style.right = '20vw';
        }
    });

    class SignInData {
        constructor(ethAddr, referrer_code, signTim, refererID) {
            this.eth_addr = ethAddr;
            this.referrer_code = referrer_code;
            this.referrer_id = refererID
            if (!signTim) {
                this.sign_time = (new Date()).getTime();
            } else {
                this.sign_time = signTim;
            }
        }
    }

    function showError(txt) {
        if (!txt || txt.length === 0) {
            document.getElementById("error-txt").textContent = '';
            document.getElementById("error-div").style.display = 'none';
            return;
        }
        document.getElementById("error-txt").textContent = txt;
        document.getElementById("error-div").style.display = 'block';
    }

    async function showSignBtn(web3ID) {
        document.querySelectorAll(".logo-container").forEach(item => item.classList.remove("active"));
        const web3IdTips = document.getElementById("web3-id-tips");
        const signInDiv = document.getElementById("sign-in-div");
        const metamaskDiv = document.getElementById("metamask-div");
        const web3Id = document.getElementById("web3-id");
        const refererDiv = document.querySelector(".referral-code-popup");

        if (!web3ID) {
            web3IdTips.style.display = 'block';
            signInDiv.style.display = 'none';
            metamaskDiv.style.display = 'block';
            web3Id.style.display = 'none';
            refererDiv.style.display = 'none';
            showError(null);
            return;
        }
        web3IdTips.style.display = 'none';
        signInDiv.style.display = 'block';
        metamaskDiv.style.display = 'none';
        web3Id.style.display = 'block';
        web3Id.textContent = web3ID;
        document.getElementById("logo-container-arbitrum").classList.add("active")
        document.getElementById("logo-container-eth").classList.add("active")

        const savedUserInfo = await loadNJUserInfoFromSrv(web3ID);
        if (!savedUserInfo) {
            refererDiv.style.display = 'block';
            return;
        }

        if (!savedUserInfo.referrer_code) {
            refererDiv.style.display = 'block';
        } else {
            refererDiv.style.display = 'none';
        }

        let tw_data = await TwitterBasicInfo.loadTwBasicInfo(savedUserInfo.tw_id);
        if (!tw_data) {
            return;
        }

        document.getElementById("logo-container-twitter").classList.add("active")
    }

    document.addEventListener("DOMContentLoaded", initPageElem);

    async function initPageElem() {
        await initDatabase();

        if (typeof window.ethereum === 'undefined') {
            await showSignBtn(null);
            return;
        }

        window.ethereum.on('accountsChanged', async function (accounts) {
            showError(null);
            if (accounts.length > 0) {
                await showSignBtn(accounts[0]);
                return;
            }
            await showSignBtn(null);
        });

        try {
            const accounts = await window.ethereum.request({method: 'eth_accounts'})
            if (accounts.length === 0) {
                await showSignBtn(null);
                return
            }
            await showSignBtn(accounts[0]);
        } catch (err) {
            console.error("Error checking MetaMask status:", err);
            showError(err);
        }
    }

    function closeReferralCode() {
        document.querySelector(".referral-code-popup").style.display = 'none';
    }

    async function setupReferralCode() {
        const referralInput = document.getElementById("referral-code-val");
        const val = referralInput.value;
        if (val.length !== referrerCodeLen) {
            showDialog(DLevel.Tips, "referral code length is:" + referrerCodeLen)
            return;
        }
        showWaiting("checking referral code");
        const referrerInfo = await loadNJUserByReferrer(val);
        if (!referrerInfo) {
            showDialog(DLevel.Tips, "no such referrer!")
            document.getElementById("referral-code-val").value = '';
            hideLoading();
            return;
        }

        hideLoading();
        const web3Id = document.getElementById("web3-id").textContent;
        if (referrerInfo.eth_addr === web3Id) {
            showDialog(DLevel.Tips, "Referrer should not be yourself")
            return;
        }

        document.querySelector(".referral-code-popup").style.display = 'none';
        referralInput.dataset.ethAddr = referrerInfo.eth_addr;
    }

    async function connectToMetamask() {
        if (!window.ethereum || !window.ethereum.isMetaMask) {
            window.open('https://metamask.io/download/', '_blank');
            return;
        }
        try {
            const accounts = await window.ethereum.request({method: "eth_requestAccounts"})
            // console.log(accounts)
            await showSignBtn(accounts[0]);
            // window.location.reload();
        } catch (error) {
            console.error("Metamask login failed:", error.code, error.message.toString());
            if (error.code === -32002) {
                showError("Please click the metamask plugin and sign in ")
                return;
            }
            showError(error.message);
        }
    }

    async function signInByEth() {
        showError(null);
        const web3Id = document.getElementById("web3-id").textContent;
        if (web3Id.length < 20) {
            showError("no valid web3 id selected");
            return;
        }
        const referralInput = document.getElementById("referral-code-val");
        const val = referralInput.value;

        const signParam = new SignInData(web3Id)
        if (val.length === referrerCodeLen) {
            signParam.referrer_code = val;
            signParam.referrer_id = referralInput.dataset.ethAddr;
        }
        const message = JSON.stringify(signParam);
        try {
            const signature = await window.ethereum.request({
                method: 'personal_sign',
                params: [message, web3Id],
            })

            showWaiting("signing in......", 15)
            const obj = new SignDataForPost(message, signature, null)
            PostToSrvByJson('/signInByEth', obj).then(response => {
                console.log("sign in by eth success", response);
                hideLoading();
                if (!response) {
                    showError("failed to load ninja user data");
                    return
                }
                window.location.href = "/main";
            }).catch(err => {
                showError(err.toString());
                hideLoading();
            })
        } catch (err) {
            showError("sign in err:\n" + err.message);
            hideLoading();
        }
    }

    function showAppList(listID, isHide) {
        if (isHide) {
            document.getElementById(listID).style.display = 'none';
        } else {
            document.getElementById(listID).style.display = 'block';
        }
    }

</script>

<script about="zh-en">
    i18next
        .use(i18nextBrowserLanguageDetector)
        .init({
            fallbackLng: 'en',
            debug: false,
            resources: {
                en: {
                    translation: {
                        "title": "SignIn Page",
                        "bridge-title": "Social Meta-Identity Mapping Table",
                        "bridge-list-sub-tittle": "Blockchain",
                        "tittle-referral-txt": "Referral code",
                        "tips-referral-txt": "Use the referral code to get 100 points",
                        "referral-code-val": "Please enter the referral code.",
                        "btn-referral-txt": "Confirm",
                        "tittle-operation-area": "Finding web3ID",
                        "web3-id-tips": "Connect MetaMask to obtain your Web3 ID",
                    }
                },
                zh: {
                    translation: {
                        "title": "登录页面",
                        "bridge-title": "社交元身份桥接表",
                        "bridge-list-sub-tittle": "区块链",
                        "tittle-referral-txt": "推荐码",
                        "tips-referral-txt": "使用推荐码获得100积分",
                        "referral-code-val": "请填写推荐码",
                        "btn-referral-txt": "确认",
                        "tittle-operation-area": "获取web3ID",
                        "web3-id-tips": "链接MetaMask以获取Web3 ID",
                    }
                }
            }
        }, function (err, t) {
            updateContent();
        });

    function updateContent() {
        document.title = i18next.t('title');
        document.getElementById('title-of-bridge-list').textContent = i18next.t('bridge-title');
        document.getElementById('bridge-list-sub-tittle').textContent = i18next.t('bridge-list-sub-tittle');
        document.getElementById('tittle-referral-txt').textContent = i18next.t('tittle-referral-txt');
        document.getElementById('tips-referral-txt').textContent = i18next.t('tips-referral-txt');
        document.getElementById('referral-code-val').placeholder = i18next.t('referral-code-val');
        document.getElementById('btn-referral-txt').textContent = i18next.t('btn-referral-txt');
        document.getElementById('tittle-operation-area').textContent = i18next.t('tittle-operation-area');
        document.getElementById('web3-id-tips').textContent = i18next.t('web3-id-tips');
    }

</script>
</body>
</html>
