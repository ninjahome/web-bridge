<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <script src="/assets/js/utils.js"></script>
    <script src="/assets/js/database.js"></script>
</head>
<body>
<div class="container">
    <!-- 信息展示部分 -->
    <div class="info-section">
        <img src="/assets/file/logo.png" alt="Dessage Logo" class="logo">
        <div class="product-name">Dessage</div>
        <div class="product-description">A dapp powered by Ninja Protocol and Blockchain.</div>
    </div>

    <!-- 登录部分 -->
    <div class="login-section">
        <div class="web3-id-label" id="web3-id-label">Web3 ID: <span id="web3-id">Your Blockchain Address</span></div>
        <div id="metamask-div">
            <button class="metamask-button" id="metamask-button" onclick="connectToMetamask()">Connect with Metamask
            </button>
        </div>
        <div id="sign-in-div">
            <button class="sign-in-button" id="sign-in-button"
                    onclick="signInByEth()">Sign In
            </button>
        </div>
    </div>
    <div id="error-div" style="display: none"><span id="error-txt"></span></div>
</div>

<script>
    function showError(txt) {
        if (!txt || txt.length === 0) {
            document.getElementById("error-txt").textContent = '';
            document.getElementById("error-div").style.display = 'none';
            return;
        }
        document.getElementById("error-txt").textContent = txt;
        document.getElementById("error-div").style.display = 'block';
    }

    function showSignBtn(web3ID) {
        const web3IdLabel = document.getElementById("web3-id-label");
        const signInDiv = document.getElementById("sign-in-div");
        const metamaskDiv = document.getElementById("metamask-div");
        const web3Id = document.getElementById("web3-id");
        if (!web3ID) {
            web3IdLabel.style.display = 'none';
            signInDiv.style.display = 'none';
            metamaskDiv.style.display = 'block';
            return;
        }
        web3IdLabel.style.display = 'block';
        signInDiv.style.display = 'block';
        metamaskDiv.style.display = 'none';
        web3Id.textContent = web3ID;
    }

    document.addEventListener("DOMContentLoaded", initElmStatus);
    let metamaskObj = null;

    async function initElmStatus() {
        if (typeof window.ethereum === 'undefined') {
            showSignBtn(null);
            return;
        }
        metamaskObj = window.ethereum;
        metamaskObj.on('accountsChanged', function (accounts) {
            if (accounts.length > 0) {
                showSignBtn(accounts[0]);
                return;
            }
            showSignBtn(null);
        });

        try {
            const accounts = await metamaskObj.request({method: 'eth_accounts'})
            if (accounts.length === 0) {
                showSignBtn(null);
                return
            }
            showSignBtn(accounts[0]);
        } catch (err) {
            console.error("Error checking MetaMask status:", err);
            showError(err);
        }
    }

    async function connectToMetamask() {
        if (!metamaskObj) {
            window.open('https://metamask.io/download/', '_blank');
            return;
        }
        try {
            await metamaskObj.request({method: "eth_requestAccounts"})
            window.location.reload();
        } catch (error) {
            console.error("Metamask login failed:", error);
            showError(error);
        }
    }

    class SignDataForPost {
        constructor(msg, sig) {
            this.message = msg;
            this.signature = sig;
        }
    }

    async function signInByEth() {
        showError(null);
        const web3Id = document.getElementById("web3-id").textContent;
        if (web3Id.length < 20) {
            showError("no valid web3 id selected");
            return;
        }

        const signParam = new SignData(web3Id)
        const message = JSON.stringify(signParam);
        try {
            const signature = await metamaskObj.request({
                method: 'personal_sign',
                params: [message, web3Id],
            })

            console.log("message:=>", message);
            console.log("signature:=>", signature);
            showWaiting("signing in......", 15)
            const obj = new SignDataForPost(message, signature)
            PostToSrvByJson('/signInByEth', obj).then(response => {
                console.log("sign in by eth success", response);
                hideLoading();
                if (!response) {
                    showError("failed to load ninja user data");
                    return
                }
                const ninjaObj = JSON.parse(response)
                console.log("got ninja object:", ninjaObj);
                setDataFromSessionDB(sesDbKeyForSignData(signParam.eth_addr), signParam);
                setDataFromSessionDB(sesDbKeyForNjUserData(), ninjaObj);
                window.location.href = "/main";
            }).catch(err => {
                showError(err.toString());
                hideLoading();
            })
        } catch (err) {
            showError("sign in err:\n"+err.message);
            hideLoading();
        }
    }

</script>
</body>
</html>
